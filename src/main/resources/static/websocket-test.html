<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
</head>
<body>
    <h1>WebSocket Connection Test</h1>
    
    <div>
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
        <button onclick="sendTestMessage()">Send Test Message</button>
    </div>
    
    <div>
        <h3>Connection Status:</h3>
        <p id="status">Disconnected</p>
    </div>
    
    <div>
        <h3>Messages:</h3>
        <div id="messages"></div>
    </div>

    <script>
        let stompClient = null;
        let socket = null;

        function connect() {
            // Try STOMP with SockJS first
            socket = new SockJS('http://localhost:8080/ws/realtime-chat');
            stompClient = Stomp.over(socket);
            
            stompClient.debug = function(str) {
                console.log('STOMP Debug: ' + str);
                addMessage('STOMP Debug: ' + str);
            };
            
            stompClient.connect({}, function(frame) {
                console.log('Connected: ' + frame);
                document.getElementById('status').innerText = 'Connected via SockJS';
                addMessage('Connected: ' + frame);
                
                // Subscribe to test topic
                stompClient.subscribe('/topic/test', function(message) {
                    console.log('Received test message: ' + message.body);
                    addMessage('Received: ' + message.body);
                });
                
                // Subscribe to user-specific messages
                stompClient.subscribe('/user/queue/realtime-chat', function(message) {
                    console.log('Received user message: ' + message.body);
                    addMessage('User Message: ' + message.body);
                });
                
            }, function(error) {
                console.log('STOMP connection error: ' + error);
                document.getElementById('status').innerText = 'STOMP Connection Failed';
                addMessage('STOMP Connection Error: ' + error);
                
                // Try direct WebSocket
                tryDirectWebSocket();
            });
        }

        function tryDirectWebSocket() {
            console.log('Trying direct WebSocket connection...');
            addMessage('Trying direct WebSocket connection...');
            
            const ws = new WebSocket('ws://localhost:8080/ws/realtime-chat-direct');
            
            ws.onopen = function(event) {
                console.log('Direct WebSocket connected');
                document.getElementById('status').innerText = 'Connected via Direct WebSocket';
                addMessage('Direct WebSocket connected');
            };
            
            ws.onmessage = function(event) {
                console.log('Direct WebSocket message: ' + event.data);
                addMessage('Direct WS Message: ' + event.data);
            };
            
            ws.onerror = function(error) {
                console.log('Direct WebSocket error: ' + error);
                document.getElementById('status').innerText = 'Direct WebSocket Failed';
                addMessage('Direct WebSocket Error: ' + error);
            };
            
            ws.onclose = function(event) {
                console.log('Direct WebSocket closed');
                addMessage('Direct WebSocket closed');
            };
        }

        function disconnect() {
            if (stompClient) {
                stompClient.disconnect();
            }
            document.getElementById('status').innerText = 'Disconnected';
            addMessage('Disconnected');
        }

        function sendTestMessage() {
            if (stompClient && stompClient.connected) {
                stompClient.send('/app/test', {}, 'Test message at ' + new Date());
                addMessage('Sent test message');
            } else {
                addMessage('Not connected');
            }
        }

        function addMessage(message) {
            const messages = document.getElementById('messages');
            const p = document.createElement('p');
            p.textContent = new Date().toLocaleTimeString() + ': ' + message;
            messages.appendChild(p);
            messages.scrollTop = messages.scrollHeight;
        }
    </script>
</body>
</html>
